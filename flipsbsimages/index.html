<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Flip SBS Images</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<style type="text/css">
			html, body {
				background: #fff;
				color: #000;
				font-family: sans-serif;
			}
			#output {
				width: 100%;
				height: auto;
			}
		</style>
	</head>
	<body>
		<p>You can flip SBS-Image for cross eye viewing here. Just select an image here, your browser will do the rest, there is no uploading going on. <strong>MPO-Files are supported, too.</strong> Optionally click/tap the image to flip sides.</p>
		<label>Select image: <input type="file" id="inputimage" name="inputimage" accept="image/*"></label>
		<p>Image will appear below. You should be able to save them, too. <strong>Browser might freeze with large files. Take care!</strong></p>
		<hr>
		<canvas id="output" width="0" height="0"></canvas>
		<hr>
		<button id="download" type="button">Bild speichern</button>

		<script type="application/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
		<script type="application/javascript" src="mpoextractor.js"></script>
		<script type="application/javascript">
			var canvas = document.getElementById("output");
			var ctx = canvas.getContext("2d");
			var img = null; var image_width = 0; var image_height = 0;
			var filename = "";

			$("#inputimage").on("change", function(evt){
				evt.preventDefault();

				var reader = new FileReader();
				if(evt.target.files.length == 1) {
					var imagefile = evt.target.files[0];
					if(imagefile.type == "image/jpeg" || imagefile.type == "image/png") {
						filename = imagefile.name + "_pakl.jpg";
						reader.onload = (function(thefile) {
							return function(e) {
								if(e.target.readyState == FileReader.DONE) {
									img = new Image();
									img.src = e.target.result;
									img.onload = function() {
										image_width = this.width; image_height = this.height;
										$("#output").prop({"width": image_width, "height": image_height});
										ctx.drawImage(this,
											0, 0,
											this.width/2, this.height,
											this.width/2, 0,
											this.width/2, this.height
										);
										ctx.drawImage(this,
											this.width/2, 0,
											this.width/2, this.height,
											0, 0,
											this.width/2, this.height
										);
									};
								}
							};
						})(imagefile);
						reader.readAsDataURL(imagefile);
					} else if(imagefile.type == "image/mpo" || imagefile.name.toLowerCase().substr(imagefile.name.length-4) == ".mpo") {
						new MPOExtracor(imagefile, function(mpo){
							if(mpo.numImgs >= 2) {
								filename = imagefile.name + "_pakl.jpg";
								var mpo_l = new Image(); mpo_l.src = "data:image/jpeg;base64," + btoa(mpo.imgs[0]);
								var mpo_r = new Image(); mpo_r.src = "data:image/jpeg;base64," + btoa(mpo.imgs[1]);
								mpo_l.onload = function() {
									mpo_r.onload = function() {
										var w = mpo_l.width + mpo_r.width;
										image_width = w; image_height = this.height;
										$("#output").prop({"width": image_width, "height": image_height});
										ctx.drawImage(mpo_l,
											0, 0,
											mpo_l.width, mpo_l.height,
											w/2, 0,
											w/2, mpo_r.height
										);
										ctx.drawImage(mpo_r,
											0, 0,
											mpo_r.width, mpo_r.height,
											0, 0,
											w/2, mpo_l.height
										);
									}
								}
							} else {
								alert("Invalid number of images in MPO package");
							}
						});
					} else {
						alert("Unsupported type for file " + imagefile.name + ": " + imagefile.type);
					}
				}
			});
			$("#output").click(function(){
				if(image_width <= 0) return;

				var left = ctx.getImageData(0, 0, image_width / 2, image_height);
				var right = ctx.getImageData(image_width / 2, 0, image_width / 2, image_height);

				ctx.putImageData(right, 0, 0);
				ctx.putImageData(left, image_width / 2, 0);
			});
			var isFileSaverSupported = false;
			try {
				isFileSaverSupported = !!new Blob;
			} catch(e) {
				$("#download").hide();
			}
			$("#download").click(function() {
				if(isFileSaverSupported && filename.length > 0 && image_width > 0 && image_height > 0) {
					canvas.toBlob(function(blob){
						saveAs(blob, filename);
					}, "image/jpeg");
				}
			});
		</script>
	</body>
</html>